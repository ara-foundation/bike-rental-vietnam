{% extends 'base.html' %}

{% block title %}Bike rental{% endblock %}

{% block header %}Bikes for rent{% endblock %}

{% block content %}
<div class="mb-4 text-center">
    <h2 class="slogan">Get the Ride You Deserve <br> Thousands of Motorcycles / Unbeatable Prices / Official Rental Providers Only!</h2>
</div>

<div id="typeFilters" class="mb-4">
    <h5 class="mb-3">Choose your stile:</h5>
    <div class="row">
        {% for bike_type in bike_types %}
            <div class="col-md-3 mb-3">
                <div class="type-filter-item" data-type="{{ bike_type.id }}">
                    <img src="{{ bike_type.image.url }}" alt="{{ bike_type.type }}" class="img-fluid">
                    <p class="text-center mt-2">{{ bike_type.type }}</p>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div id="ridePurposeFilters" class="mb-4">
    <h5 class="mb-3">What type of ride are you planning?</h5>
    <div class="row">
        {% for ride_purpose in ride_purposes %}
            <div class="col-md-4 mb-3">
                <div class="ride-purpose-filter-item" data-purpose="{{ ride_purpose.id }}">
                    <img src="{{ ride_purpose.image.url }}" alt="{{ ride_purpose.name }}" class="img-fluid">
                    <p class="text-center mt-2">{{ ride_purpose.name }}</p>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <!-- Здесь будут фильтры -->
        <div id="mainFilters" class="mb-4">
            <form id="filterForm" method="get">
                <div class="mb-3">
                    <label class="form-label">Brand</label>
                    <div id="brand-filter" class="d-flex flex-wrap justify-content-start align-items-center">
                        {% for brand in brands %}
                            <div class="brand-logo-container m-1" data-brand-id="{{ brand.id }}">
                                <img src="{{ brand.logo.url }}" alt="{{ brand.name }}" class="brand-logo" title="{{ brand.name }}">
                            </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="brand" id="brand" value="{{ selected_brand }}">
                </div>
                <div class="mb-3">
                    <label for="search" class="form-label">Search by brand or model:</label>
                    <input type="text" name="search" id="search" class="form-control" placeholder="Enter brand or model">
                </div>
                <div class="mb-3">
                    <label for="transmission" class="form-label">Transmission</label>
                    <select name="transmission" id="transmission" class="form-select">
                        <option value="">All Transmissions</option>
                        {% for transmission in transmissions %}
                            <option value="{{ transmission }}" {% if transmission == selected_transmission %}selected{% endif %}>{{ transmission }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="gears" class="form-label">Number of Gears</label>
                    <select name="gears" id="gears" class="form-select">
                        <option value="">All</option>
                        {% for gear in gears %}
                            <option value="{{ gear }}" {% if gear == selected_gears %}selected{% endif %}>{{ gear }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="fuel_system" class="form-label">Fuel System</label>
                    <select name="fuel_system" id="fuel_system" class="form-select">
                        <option value="">All</option>
                        {% for fs in fuel_systems %}
                            <option value="{{ fs }}" {% if fs == selected_fuel_system %}selected{% endif %}>{{ fs }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="displacement" class="form-label">Engine (cc)</label>
                    <select name="displacement" id="displacement" class="form-select">
                        <option value="">All</option>
                        {% for disp in displacements %}
                            <option value="{{ disp }}" {% if disp == selected_displacement %}selected{% endif %}>{{ disp }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="wheel_size" class="form-label">Wheel (in)</label>
                    <select name="wheel_size" id="wheel_size" class="form-select">
                        <option value="">All</option>
                        {% for size in wheel_sizes %}
                            <option value="{{ size }}" {% if size == selected_wheel_size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Weight Category</label>
                    <div id="weight-filter" class="d-flex justify-content-between">
                        <div class="weight-category-item" data-weight="Light">
                            <i class="bi bi-cloud"></i>
                            <span>Light</span>
                        </div>
                        <div class="weight-category-item" data-weight="Middle">
                            <i class="bi bi-bicycle"></i>
                            <span>Middle</span>
                        </div>
                        <div class="weight-category-item" data-weight="Heavy">
                            <i class="bi bi-truck"></i>
                            <span>Heavy</span>
                        </div>
                    </div>
                    <input type="hidden" name="weight" id="weight" value="{{ selected_weight }}">
                </div>
                <div class="mb-3">
                    <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
    <div class="col-md-9">
        <!-- Здесь будет выдача поиска -->
        {% if applied_filters %}
        <div class="mt-3 mb-4">
            <h6>Applied Filters:</h6>
            <ul class="list-inline">
                {% for filter_name, filter_value in applied_filters.items %}
                    <li class="list-inline-item">
                        <span class="badge bg-secondary">
                            {{ filter_name|title }}: {{ filter_value }}
                            <a href="#" class="remove-filter text-white" data-filter="{{ filter_name }}" title="Удалить фильтр">
                                <i class="bi bi-x-circle"></i>
                            </a>
                        </span>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="mt-3 mb-4">
            <h6>{{ bike_rental_count }} 
                {% if bike_rental_count == 1 %}model{% else %}models{% endif %} available.
            </h6>
        </div>

        <div class="row mt-4">
            {% for bikemodel in bike_rental %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-img-top-wrapper position-relative">
                            {% if bikemodel.bike_model_photo %}
                                <img src="{{ bikemodel.bike_model_photo.url }}" alt="{{ bikemodel.model }}" class="card-img-top">
                            {% else %}
                                <span class="text-muted">Photo not available</span>
                            {% endif %}
                            {% with min_price=bikemodel.get_min_price_per_day %}
                                {% if min_price %}
                                    <div class="price-overlay">
                                        <p class="mb-0"><i class="bi bi-currency-dollar" title="Price per day"></i> from: <br> {{ min_price }} $/day</p>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="brand-model-overlay">
                                {% if bikemodel.brand.logo %}
                                    <img src="{{ bikemodel.brand.logo.url }}" alt="{{ bikemodel.brand.name }} logo" class="brand-logo">
                                {% endif %}
                                <h5 class="card-title">{{ bikemodel.model }}</h5>
                            </div>
                
                            <div class="specs-container">
                                <div class="row specs-row mb-2">
                                    {% with specs=bikemodel.get_specs_with_icons %}
                                        {% for spec, data in specs %}
                                            <div class="col-4 text-center">
                                                <i class="bi {{ data.icon }}" title="{{ spec|title }}"></i> {{ data.value }}
                                            </div>
                                            {% if forloop.counter|divisibleby:3 and not forloop.last %}
                                                </div><div class="row specs-row mb-2">
                                            {% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <p class="mb-0"><i class="bi bi-bicycle"></i> 
                                    {{ bikemodel.bike_set.count }} 
                                    {% if bikemodel.bike_set.count == 1 %}offer{% else %}offers{% endif %}
                                </p>
                                <a href="{% url 'bike_rental_offers' bikemodel.brand.name bikemodel.id %}" class="btn btn-primary btn-sm">View Offers</a>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <p class="text-center">No motorcycles found</p>
                </div>
            {% endfor %}
        </div>

        {% if is_paginated %}
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page=1">&laquo; First</a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a></li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}

        {% block extra_js %}
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filterForm = document.getElementById('filterForm');
            const typeFilterItems = document.querySelectorAll('.type-filter-item');
            const ridePurposeFilterItems = document.querySelectorAll('.ride-purpose-filter-item');
            const brandFilter = document.getElementById('brand-filter');
            const brandInput = document.getElementById('brand');
            const brandLogos = brandFilter.querySelectorAll('.brand-logo-container');
            const weightFilter = document.getElementById('weight-filter');
            const weightInput = document.getElementById('weight');
            const weightItems = weightFilter.querySelectorAll('.weight-category-item');
            
            // Функция для удаления фильтра
            function removeFilter(filter) {
                const element = filterForm.elements[filter];
                if (element) {
                    element.value = '';
                }
                filterForm.submit();
            }
            
            // Добавляем скрытые поля для типа мотоцикла и цели поездки в форму
            const typeInput = document.createElement('input');
            typeInput.type = 'hidden';
            typeInput.name = 'bike_type';
            typeInput.id = 'bike_type';
            filterForm.appendChild(typeInput);

            const purposeInput = document.createElement('input');
            purposeInput.type = 'hidden';
            purposeInput.name = 'ride_purpose';
            purposeInput.id = 'ride_purpose';
            filterForm.appendChild(purposeInput);
            
            function handleFilterClick(items, input) {
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.type || this.dataset.purpose;
                        if (input.value === value) {
                            input.value = '';
                            this.classList.remove('selected');
                        } else {
                            input.value = value;
                            items.forEach(i => i.classList.remove('selected'));
                            this.classList.add('selected');
                        }
                        filterForm.submit();
                    });
                });
            }

            brandLogos.forEach(logo => {
                logo.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    updateBrandInput();
                });
            });

            function updateBrandInput() {
                const selectedBrands = Array.from(brandFilter.querySelectorAll('.selected'))
                    .map(el => el.dataset.brandId);
                brandInput.value = selectedBrands.join(',');
                // Автоматически отправляем форму при изменении выбора
                document.getElementById('filterForm').submit();
            }

            // Выделяем выбранные бренды при загрузке страницы
            const selectedBrands = brandInput.value.split(',');
            selectedBrands.forEach(brandId => {
                const logo = brandFilter.querySelector(`[data-brand-id="${brandId}"]`);
                if (logo) {
                    logo.classList.add('selected');
                }
            });

            // Добавляем обработчики событий для кнопок удаления фильтров
            document.querySelectorAll('.remove-filter').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    const filter = this.getAttribute('data-filter');
                    removeFilter(filter);
                });

            handleFilterClick(typeFilterItems, typeInput);
            handleFilterClick(ridePurposeFilterItems, purposeInput);
            
            // Выделяем выбранные фильтры при загрузке страницы
            [typeInput, purposeInput].forEach(input => {
                const selectedValue = input.value;
                if (selectedValue) {
                    const selector = input.name === 'bike_type' ? '.type-filter-item' : '.ride-purpose-filter-item';
                    const selectedItem = document.querySelector(`${selector}[data-${input.name.replace('_', '-')}="${selectedValue}"]`);
                    if (selectedItem) {
                        selectedItem.classList.add('selected');
                    }
                }
            });

            weightItems.forEach(item => {
                item.addEventListener('click', function() {
                    const weight = this.dataset.weight;
                    if (weightInput.value === weight) {
                        weightInput.value = '';
                        this.classList.remove('selected');
                    } else {
                        weightInput.value = weight;
                        weightItems.forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                    document.getElementById('filterForm').submit();
                });
            });

            // Выделяем выбранную категорию веса при загрузке страницы
            const selectedWeight = weightInput.value;
            if (selectedWeight) {
                const selectedItem = weightFilter.querySelector(`[data-weight="${selectedWeight}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                }
            }
        });
        </script>
        <script>
            $(function() {
                $("#search").autocomplete({
                    source: "{% url 'autocomplete' %}",
                    minLength: 2,
                    select: function(event, ui) {
                        $("#search").val(ui.item.value);
                        $("#filterForm").submit();
                    }
                }).autocomplete("instance")._renderItem = function(ul, item) {
                    return $("<li>")
                        .append("<div>" + item.value + "</div>")
                        .appendTo(ul);
                };
            });
        </script>
        {% endblock %}

        {% endblock %}