{% extends 'base.html' %}

{% block title %}Bike rental{% endblock %}

{% block header %}Bikes for rent{% endblock %}

{% block content %}
<div class="mb-4 text-center">
    <h2 class="slogan">Get the Ride You Deserve <br> Thousands of Motorcycles / Unbeatable Prices / Official Rental Providers Only!</h2>
</div>

<div id="typeFilters" class="mb-4">
    <h5 class="mb-3">Choose your style:</h5>
    <div class="row">
        {% for bike_type in bike_types %}
            <div class="col-md-3 mb-3">
                <div class="type-filter-item" data-type="{{ bike_type.id }}">
                    <img src="{{ bike_type.image.url }}" alt="{{ bike_type.type }}" class="img-fluid">
                    <p class="text-center mt-2">{{ bike_type.type }}</p>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div id="ridePurposeFilters" class="mb-4">
    <h5 class="mb-3">What type of ride are you planning?</h5>
    <div class="row">
        {% for ride_purpose in ride_purposes %}
            <div class="col-md-4 mb-3">
                <div class="ride-purpose-filter-item" data-purpose="{{ ride_purpose.id }}">
                    <img src="{{ ride_purpose.image.url }}" alt="{{ ride_purpose.name }}" class="img-fluid">
                    <p class="text-center mt-2">{{ ride_purpose.name }}</p>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <!-- Здесь будут фильтры -->
        <div id="mainFilters" class="mb-4">
            <form id="filterForm" method="get">
                <div class="mb-3">
                    <label class="form-label">Brand</label>
                    <div id="brand-filter" class="d-flex flex-wrap justify-content-start align-items-center">
                        {% for brand in brands %}
                            <div class="brand-logo-container m-1" data-brand-id="{{ brand.id }}">
                                <img src="{{ brand.logo.url }}" alt="{{ brand.name }}" class="brand-logo" title="{{ brand.name }}">
                            </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="brand" id="brand" value="{{ selected_brand }}">
                </div>
                <div class="mb-3">
                    <input type="text" name="search" id="search" class="form-control" placeholder="Search by model" value="{{ request.GET.search }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Price</label>
                    <div id="price-category-filter" class="d-flex justify-content-between">
                        <div class="price-category-item" data-price-category="Budget">
                            <span>Budget</span>
                            <i class="bi bi-piggy-bank"></i>
                            <small>≤$50</small>
                        </div>
                        <div class="price-category-item" data-price-category="Standard">
                            <span>Standard</span>
                            <i class="bi bi-cash-coin"></i>
                            <small>$51-$100</small>
                        </div>
                        <div class="price-category-item" data-price-category="Premium">
                            <span>Premium</span>
                            <i class="bi bi-gem"></i>
                            <small>>$100</small>
                        </div>
                    </div>
                    <input type="hidden" name="price_category" id="price_category" value="{{ selected_price_category }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Pick your height:</label>
                    <div id="seat-height-filter" class="d-flex justify-content-between">
                        <div class="seat-height-category-item" data-seat-height="Low">
                            <span>Low</span>
                            <i class="bi bi-arrow-down-circle"></i>
                            
                            <small><170 cm</small>
                        </div>
                        <div class="seat-height-category-item" data-seat-height="Middle">
                            <span>Middle</span>

                            <i class="bi bi-arrow-left-right"></i>
                            <small>170-180 cm</small>
                        </div>
                        <div class="seat-height-category-item" data-seat-height="High">
                            <span>High</span>
                            <i class="bi bi-arrow-up-circle"></i>
                            <small>>180 cm</small>
                        </div>
                    </div>
                    <input type="hidden" name="seat_height" id="seat_height" value="{{ selected_seat_height }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Bike weight:</label>
                    <div id="weight-filter" class="d-flex justify-content-between">
                        <div class="weight-category-item" data-weight="Light">
                            <span>Light</span>
                            <i class="bi bi-cloud"></i>                            

                            <small>≤120 kg</small>
                        </div>
                        <div class="weight-category-item" data-weight="Middle">
                            
                            <span>Middle</span>
                            <i class="bi bi-bicycle"></i>

                            <small>121-180 kg</small>
                        </div>
                        <div class="weight-category-item" data-weight="Heavy">
                            <span>Heavy</span>
                            <i class="bi bi-truck"></i>
                            <small>>180 kg</small>
                        </div>
                    </div>
                    <input type="hidden" name="weight" id="weight" value="{{ selected_weight }}">
                </div>
                <div class="mb-3 text-center">
                    <button id="expertFiltersBtn" class="btn btn-secondary w-100">
                        Expert Filters <i class="bi bi-chevron-down" id="expertFiltersIcon"></i>
                    </button>
                </div>

                <div id="expertFilters" style="display: none;">
                    <div class="mb-3">
                        <label for="transmission" class="form-label">Transmission</label>
                        <select name="transmission" id="transmission" class="form-select">
                            <option value="">All Transmissions</option>
                            {% for transmission in transmissions %}
                                <option value="{{ transmission }}" {% if transmission == selected_transmission %}selected{% endif %}>{{ transmission }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="gears" class="form-label">Number of Gears</label>
                        <select name="gears" id="gears" class="form-select">
                            <option value="">All</option>
                            {% for gear in gears %}
                                <option value="{{ gear }}" {% if gear == selected_gears %}selected{% endif %}>{{ gear }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="fuel_system" class="form-label">Fuel System</label>
                        <select name="fuel_system" id="fuel_system" class="form-select">
                            <option value="">All</option>
                            {% for fs in fuel_systems %}
                                <option value="{{ fs }}" {% if fs == selected_fuel_system %}selected{% endif %}>{{ fs }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="displacement" class="form-label">Engine (cc)</label>
                        <select name="displacement" id="displacement" class="form-select">
                            <option value="">All</option>
                            {% for disp in displacements %}
                                <option value="{{ disp }}" {% if disp == selected_displacement %}selected{% endif %}>{{ disp }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="clearance" class="form-label">Clearance (mm)</label>
                        <select name="clearance" id="clearance" class="form-select">
                            <option value="">All</option>
                            {% for size in clearances %}
                                <option value="{{ size }}" {% if size == selected_clearance %}selected{% endif %}>{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <button id="applyFiltersBtn" class="btn btn-primary w-100">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
    <div class="col-md-9">
        <!-- Здесь будет выдача поиска -->

        <div class="mt-3 mb-4">
            <h6>{{ bike_rental_count }} 
                {% if bike_rental_count == 1 %}model{% else %}models{% endif %} available.
            </h6>
        </div>

        <div class="mt-3 mb-4">
            <h6>Примененные фильтры:</h6>
            <ul id="appliedFiltersList" class="list-inline"></ul> <!-- Список для отображения примененных фильтров -->
        </div>

        <div class="row mt-4">
            {% for bikemodel in bike_rental %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-img-top-wrapper position-relative">
                            {% if bikemodel.bike_model_photo %}
                                <img src="{{ bikemodel.bike_model_photo.url }}" alt="{{ bikemodel.model }}" class="card-img-top">
                            {% else %}
                                <span class="text-muted">Photo not available</span>
                            {% endif %}
                            {% with min_price=bikemodel.get_min_price_per_day %}
                                {% if min_price %}
                                    <div class="price-overlay">
                                        <p class="mb-0"><i class="bi bi-currency-dollar" title="Price per day"></i> from: <br> {{ min_price }} $/day</p>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="brand-model-overlay">
                                {% if bikemodel.brand.logo %}
                                    <img src="{{ bikemodel.brand.logo.url }}" alt="{{ bikemodel.brand.name }} logo" class="brand-logo">
                                {% endif %}
                                <h5 class="card-title">{{ bikemodel.model }}</h5>
                            </div>
                
                            <div class="specs-container">
                                <div class="row specs-row mb-2">
                                    {% with specs=bikemodel.get_specs_with_icons %}
                                        {% for spec, data in specs %}
                                            <div class="col-4 text-center">
                                                <i class="bi {{ data.icon }}" title="{{ spec|title }}"></i> {{ data.value }}
                                            </div>
                                            {% if forloop.counter|divisibleby:3 and not forloop.last %}
                                                </div><div class="row specs-row mb-2">
                                            {% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <p class="mb-0"><i class="bi bi-bicycle"></i> 
                                    {{ bikemodel.bike_set.count }} 
                                    {% if bikemodel.bike_set.count == 1 %}offer{% else %}offers{% endif %}
                                </p>
                                <a href="{% url 'bike_rental_offers' bikemodel.brand.name bikemodel.id %}" class="btn btn-primary btn-sm">View Offers</a>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <p class="text-center">No motorcycles found</p>
                </div>
            {% endfor %}
        </div>

        {% if is_paginated %}
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page=1">&laquo; First</a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a></li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    let brandFilter = document.getElementById('brand-filter'); // Инициализируем переменную сразу

    function updateBrandInput() {
        const selectedBrands = Array.from(brandFilter.querySelectorAll('.selected')).map(el => el.dataset.brandId);
        document.getElementById('brand').value = selectedBrands.join(',');
        console.log("Selected Brands:", selectedBrands);

    }

    function updateSelectedBrandsDisplay(appliedFilters) {
        const selectedBrandsDiv = document.getElementById('appliedFiltersList');
        selectedBrandsDiv.innerHTML = ''; // Очищаем предыдущие элементы
        if (appliedFilters.length > 0) {
            appliedFilters.forEach(filter => {
                const listItem = document.createElement('li');
                listItem.classList.add('list-inline-item');
                listItem.innerHTML = `
                    <span class="badge bg-secondary">
                        ${filter.name}
                        <a href="#" class="remove-filter text-white" data-brand-id="${filter.id}" title="Удалить фильтр" onclick="removeFilter('${filter.id}')">
                            <i class="bi bi-x-circle"></i>
                        </a>
                    </span>
                `;
                selectedBrandsDiv.appendChild(listItem);
            });
        } else {
            selectedBrandsDiv.textContent = 'Нет выбранных брендов';
        }
    }

    function displayAppliedFilters(selectedBrands) {
        const appliedFiltersList = document.getElementById('appliedFiltersList');
        appliedFiltersList.innerHTML = '';
        if (selectedBrands.length > 0) {
            selectedBrands.forEach(brandId => {
                const brandElement = brandFilter.querySelector(`[data-brand-id="${brandId}"]`);
                if (brandElement) {
                    const brandName = brandElement.querySelector('img').alt;
                    const listItem = document.createElement('li');
                    listItem.classList.add('list-inline-item');
                    listItem.innerHTML = `
                        <span class="badge bg-secondary">
                            ${brandName}
                            <button type="button" class="remove-filter text-white" data-brand-id="${brandId}" title="Удалить фильтр" onclick="removeFilter('${brandId}')">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </span>
                    `;
                    appliedFiltersList.appendChild(listItem);
                }

            });
        } else {
            appliedFiltersList.textContent = 'Нет примененных фильтров';
        }
    }
    
    function addFilter(brandId, brandName) {
    let appliedFilters = JSON.parse(localStorage.getItem('appliedFilters')) || [];
    if (!appliedFilters.some(filter => filter.id === brandId)) {
        appliedFilters.push({ id: brandId, name: brandName });
        localStorage.setItem('appliedFilters', JSON.stringify(appliedFilters));
    }
}

function removeFilter(brandId) {
    const brandElement = brandFilter.querySelector(`[data-brand-id="${brandId}"]`);
    if (brandElement) {
        brandElement.classList.remove('selected'); // Удаляем класс 'selected'
    }
    let appliedFilters = JSON.parse(localStorage.getItem('appliedFilters')) || [];
    appliedFilters = appliedFilters.filter(filter => filter.id !== brandId); // Удаляем фильтр
    localStorage.setItem('appliedFilters', JSON.stringify(appliedFilters));
    updateBrandInput(); // Обновляем состояние фильтров
    updateSelectedBrandsDisplay(appliedFilters); // Обновляем отображение выбранных брендов
}

    // Обработчик клика по фильтрам
    brandFilter.addEventListener('click', function(event) {
        const selectedBrand = event.target.closest('.brand-logo-container');
        if (selectedBrand) {
            const brandId = selectedBrand.dataset.brandId;
            const brandName = selectedBrand.querySelector('img').alt; // Получаем имя бренда
            selectedBrand.classList.toggle('selected');
            updateBrandInput();

            // Добавляем или удаляем фильтр
            if (selectedBrand.classList.contains('selected')) {
                addFilter(brandId, brandName); // Добавляем фильтр
            } else {
                removeFilter(brandId); // Удаляем фильтр
            }
        }
    });

    // Обработчик клика по кнопкам удаления фильтров
    document.getElementById('appliedFiltersList').addEventListener('click', function(event) {
        const button = event.target.closest('.remove-filter');
        if (button) {
            const brandId = button.dataset.brandId; // Получаем ID бренда для удаления
            const url = new URL(window.location.href);
            // Удаляем конкретный brandId
            let brands = url.searchParams.getAll('brand');
            brands = brands.filter(id => id !== brandId); // Удаляем конкретный ID
            // Обновляем параметры URL
            url.searchParams.delete('brand'); // Удаляем параметр brand
            brands.forEach(id => url.searchParams.append('brand', id)); // Добавляем оставшиеся ID обратно
            url.searchParams.append('remove_brand', brandId); // Добавляем параметр для удаления
            window.location.href = url; // Перезагружаем страницу с обновленным URL
        }
    });

    // Инициализация отображения примененных фильтров
    const appliedFilters = JSON.parse(localStorage.getItem('appliedFilters')) || [];
    updateSelectedBrandsDisplay(appliedFilters);
    console.log(JSON.parse(localStorage.getItem('')));
    console.log(JSON.parse(localStorage.getItem('appliedFilters')));
    appliedFilters.forEach(filter => {
        const brandElement = brandFilter.querySelector(`[data-brand-id="${filter.id}"]`);
        if (brandElement) {
            brandElement.classList.add('selected');
        }
    });

    console.log("Applied Filters:", appliedFilters);
    console.log("Current URL:", window.location.href);
</script>
{% endblock %}


        