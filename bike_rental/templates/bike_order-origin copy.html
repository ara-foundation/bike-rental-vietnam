{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}Order {{ bike.bike_model.brand.name }} {{ bike.bike_model.model }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
{% endblock %}

{% block header %}Order {{ bike.bike_model.brand.name }} {{ bike.bike_model.model }}{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Order Details</h5>
                <form method="post">
                    {% csrf_token %}
                    <h6>Client Information</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ client_form.name.id_for_label }}" class="form-label">Name</label>
                                {{ client_form.name|add_class:"form-control" }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ client_form.contact.id_for_label }}" class="form-label">Contact</label>
                                {{ client_form.contact|add_class:"form-control" }}
                            </div>
                        </div>
                    </div>
                    <h6>Order Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ order_form.start_date.id_for_label }}" class="form-label">Start Date</label>
                                <div class="input-group date">
                                    {{ order_form.start_date }}
                                    <span class="input-group-text" id="calendar-icon" role="button"><i
                                            class="bi bi-calendar"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ order_form.amount_bikes.id_for_label }}" class="form-label">Number of Bikes</label>
                                {{ order_form.amount_bikes|add_class:"form-control" }}
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="customRange3" class="form-label">
                                    Duration <span id="durationValue"></span> days
                                </label>
                                {{ order_form.duration }}
                            </div>
                        </div>
                    </div>
                    <div id="totalPrice">Total Price: $<span id="totalPriceValue">0.00</span></div>
                    <input type="hidden" name="client_total_price" id="client_total_price" value="0">
                    <button type="submit" class="btn btn-primary mt-3 w-100">Submit Order</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-img-top-wrapper" style="height: 300px; overflow: hidden;">
                {% if bike.photo %}
                <img src="{{ bike.photo.url }}" alt="{{ bike.bike_model }}" class="card-img-top"
                    style="object-fit: cover; height: 100%; width: 100%;">
                {% else %}
                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 100%;">
                    <span class="text-muted">No photo available</span>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                <p class="card-text">Model: {{ bike.bike_model.brand.name }} {{ bike.bike_model.model }}</p>
                <h6>Price Information</h6>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Duration</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in prices %}
                            <tr>
                                <td>{{ price.duration }} days</td>
                                <td>${{ price.cost }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
            </div>
        </div>
    </div>
</div>
{% if form.errors or client_form.errors %}
    <div class="alert alert-danger">
        <ul>
            {% for field, errors in form.errors.items %}
                <li>{{ field }}: {{ errors|join:", " }}</li>
            {% endfor %}
            {% for field, errors in client_form.errors.items %}
                <li>{{ field }}: {{ errors|join:", " }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}
<a href="{% url 'bike_offer' bike.id %}" class="btn btn-secondary mt-4"><i class="bi bi-arrow-left me-2"></i>Back to bike offer</a>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM fully loaded');
        const calendarIcon = document.querySelector('#calendar-icon');
        const startDateInput = document.querySelector('#id_start_date');       
        const prices = {{ prices|safe }}; // Получите цены из контекста
        const durationInput = document.querySelector('#customRange3');
        const amountBikesInput = document.querySelector('#id_amount_bikes');
        const totalPriceSpan = document.querySelector('#totalPriceValue');
        console.log('startDateInput:', startDateInput);
        console.log('durationInput:', durationInput);
        console.log('amountBikesInput:', amountBikesInput);
        console.log('totalPriceSpan:', totalPriceSpan);// Установка начального значения
        // Инициализация datepicker (если используется Bootstrap Datepicker)
        $(startDateInput).datepicker({
            format: 'dd-mm-yy',
            todayHighlight: true,
            autoclose: true,
        });

        // Установка начального значения
        durationValueSpan.textContent = durationInput.value;

        function calculateLocalTotalPrice(duration, amountBikes) {
            let totalPrice = Infinity;
            prices.forEach(price => {
                let localTotalPrice = 0;
                if (price.duration <= duration) {
                    localTotalPrice = (price.cost / price.duration) * duration * amountBikes;
                    if (price.duration > duration) {
                
                    localTotalPrice = price.cost * amountBikes;
                    totalPrice = Math.min(localTotalPrice, price.cost * amountBikes);
                }
            });
            return totalPrice === Infinity ? 0 : totalPrice; // Если не найдено, возвращаем 0
        }

        function updateTotalPrice() {
            const duration = parseInt(durationInput.value);
            const amountBikes = parseInt(amountBikesInput.value);
            const localTotalPrice = calculateLocalTotalPrice(duration, amountBikes);
            totalPriceSpan.textContent = localTotalPrice.toFixed(2);
            document.getElementById('client_total_price').value = localTotalPrice.toFixed(2);
        }

        [startDateInput, durationInput, amountBikesInput].forEach(input => {
            input.addEventListener('change', updateTotalPrice);
        });

        durationInput.addEventListener('input', function() {
            durationValueSpan.textContent = this.value;
            updateTotalPrice(); // Обновляем цену при изменении значения
        });

        updateTotalPrice();  // Начальный расчет
    });
</script>
{% endblock %}